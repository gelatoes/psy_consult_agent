# 双重记忆系统实现指南

本文档提供心理咨询系统双重记忆功能的实现说明和使用指南。

## 1. 架构说明

双重记忆系统通过以下方式实现：

- **JSON文件存储**：提供人类可读/可编辑的记忆持久化
- **向量数据库存储**：提供高效检索和查询功能
- **自动同步机制**：确保两个存储系统数据保持一致
- **学生特征向量**：支持基于历史案例相似度的智能咨询师选择

系统启动时，会检查两个存储的状态，必要时从一个存储重建另一个存储。

### 关键文件

- `src/memory/json_store.py`: JSON存储实现
- `src/memory/enhanced_memory_manager.py`: 增强型记忆管理器
- `src/memory/initializer.py`: 记忆系统初始化器
- `src/memory/system_initializer.py`: 应用启动初始化逻辑
- `src/utils/vector_utils.py`: 向量化工具类
- `src/utils/therapist_selector.py`: 智能咨询师选择器
- `tools/memory_system_tool.py`: 记忆系统管理工具

## 2. 安装步骤

1. 将以下文件添加到您的项目中:
   - `src/memory/json_store.py`
   - `src/memory/json_schemas.py`
   - `src/memory/enhanced_memory_manager.py`
   - `src/memory/initializer.py`
   - `src/memory/system_initializer.py`
   - `src/utils/vector_utils.py`
   - `src/utils/therapist_selector.py`

2. 修改现有文件:
   - 更新 `src/memory/memory_manager.py` 使其继承自增强型记忆管理器
   - 更新 `src/main.py` 以使用 `MemorySystemInitializer`
   - 更新 `src/system.py` 以支持接收已初始化的记忆管理器
   - 更新 `src/controllers/consultation_controller.py` 中的治疗师选择方法
   - 更新 `src/agents/supervisor_agent.py` 中的创建病历方法以支持特征向量

3. 添加工具脚本:
   - 将 `tools/memory_system_tool.py` 添加到项目中
   - 创建 `demos/memory_demo.py` 用于演示和测试

## 3. 功能说明

### 3.1 自动同步

系统启动时会自动检查同步情况：

- 如果两个存储都存在 → 自动增量同步
- 如果只有JSON文件 → 从JSON重建向量数据库
- 如果只有向量数据库 → 从向量数据库重建JSON文件
- 如果都不存在 → 创建空的记忆系统

### 3.2 写入操作流程

每次写入操作会：

1. 首先写入JSON文件
2. 然后更新向量数据库
3. 如果向量数据库更新失败，系统仍将继续工作（回退到JSON模式）

### 3.3 读取操作流程

1. 直接从向量数据库读取数据
2. 如果向量数据库读取失败，自动回退到JSON文件读取

### 3.4 学生特征向量

1. 创建病历时自动生成学生特征向量
2. 特征向量存储在 `student_vectors` 集合中
3. 向量索引记录在 `vector_index.json` 文件中
4. 系统重建时会自动重建特征向量及其索引

### 3.5 智能咨询师选择

1. 根据当前学生的特征向量，查找相似的历史案例
2. 计算每个治疗流派的有效性得分：相似度 × 改善分数
3. 选择综合得分最高的治疗师流派
4. 自动适应新增的病历数据，不断优化选择策略

## 4. 如何使用记忆系统管理工具

### 4.1 列出技能记忆

```bash
# 列出所有侧写师技能
python tools/memory_system_tool.py list-skills profiler

# 列出所有CBT咨询师技能
python tools/memory_system_tool.py list-skills therapist --therapy_type cbt
```

### 4.2 列出医疗记录

```bash
# 列出所有医疗记录
python tools/memory_system_tool.py list-records

# 列出特定学生的医疗记录
python tools/memory_system_tool.py list-records --student_id stu001
```

### 4.3 列出特征向量

```bash
# 列出所有学生特征向量
python tools/memory_system_tool.py list-vectors

# 列出特定学生的特征向量
python tools/memory_system_tool.py list-vectors --student_id stu001
```

### 4.4 添加技能记忆

```bash
# 添加侧写师技能
python tools/memory_system_tool.py add-skill profiler --content "在侧写过程中观察学生的非语言线索，如眼神回避、身体姿势等，可以帮助发现学生言语中未表达的情绪状态。"

# 添加CBT咨询师技能
python tools/memory_system_tool.py add-skill therapist --therapy_type cbt --content "对于完美主义导致的学业压力，指导学生设定合理的'足够好'标准，而非追求完美，帮助打破'非黑即白'的思维模式。"
```

### 4.5 验证记忆系统状态

```bash
# 检查两个存储的状态和一致性
python tools/memory_system_tool.py validate
```

### 4.6 强制同步

```bash
# 强制同步JSON和向量数据库
python tools/memory_system_tool.py sync
```

### 4.7 重置记忆系统

```bash
# 删除向量数据库并从JSON重建（会提示确认）
python tools/memory_system_tool.py reset

# 强制重置，不提示确认
python tools/memory_system_tool.py reset --force
```

## 5. 高级使用场景

### 5.1 预加载记忆

您可以在系统实际运行前，手动编辑JSON文件来预先创建记忆：

1. 在 `src/json-memories/` 目录下编辑对应的JSON文件
2. 运行 `python tools/memory_system_tool.py reset --force` 重建向量数据库
3. 启动系统，系统将使用预加载的记忆

### 5.2 修复记忆系统

如果遇到记忆系统问题：

1. 运行 `python tools/memory_system_tool.py validate` 检查状态
2. 如果发现不一致，运行 `python tools/memory_system_tool.py sync` 同步
3. 如果问题仍然存在：
   - 先使用 `python tools/memory_system_tool.py reset` 重置向量数据库
   - 然后执行 `python tools/memory_system_tool.py import-test` 测试导入
   - 再次检查状态，确认JSON和向量数据库条目是否对应

### 5.3 备份和恢复记忆

1. **备份**：复制 `src/json-memories/` 目录中的所有文件
2. **恢复**：
   - 将备份的JSON文件复制回 `src/json-memories/` 目录
   - 运行 `python tools/memory_system_tool.py reset --force` 重建向量数据库
   - 执行 `python tools/memory_system_tool.py validate` 验证恢复状态

### 5.4 向量系统重建

如果特征向量系统出现问题：

1. 确保 `vector_index.json` 文件存在并有效
2. 如文件缺失或损坏，系统会在重置时尝试从医疗记录自动重建特征向量
3. 重建后可使用 `python tools/memory_system_tool.py list-vectors` 检查特征向量状态

## 6. 注意事项

1. **不要直接修改向量数据库文件**，应该通过修改JSON文件然后重建向量数据库
2. 在Windows系统上，如果遇到文件锁定问题，请确保关闭所有使用记忆系统的程序后再执行重置
3. 如果您需要修改记忆结构，请确保JSON模式和代码保持一致
4. 建议定期备份JSON文件，以防数据丢失
5. 特征向量索引文件 `vector_index.json` 是连接病历和特征向量的关键，请妥善维护

## 7. 故障排除

### 7.1 同步失败

如果遇到同步失败，请检查：
- ChromaDB版本是否兼容（建议使用0.6.3版本）
- 是否有足够的文件系统权限
- 是否有进程锁定了文件

### 7.2 向量数据库下载缓慢

ChromaDB首次初始化时会下载嵌入模型，如果下载速度慢，可以：
1. 增加超时设置
2. 使用代理或VPN
3. 手动下载模型文件到缓存目录

### 7.3 特征向量相关问题

如果特征向量系统不工作：
1. 检查 `vector_index.json` 文件是否存在
2. 验证 `student_vectors` 集合是否在向量数据库中存在
3. 确保病历数据包含完整的基本信息和心理画像
4. 尝试使用 `reset` 命令重建整个向量系统

如有其他问题，请运行 `python tools/memory_system_tool.py validate` 检查系统状态，并根据输出进行排查。

### 7.4 重建特征向量

如需手动触发特征向量重建：
1. 删除 `vector_index.json` 文件或将其内容设为空对象 `{}`
2. 执行 `python tools/memory_system_tool.py reset --force`
3. 系统将自动从现有病历重建所有特征向量