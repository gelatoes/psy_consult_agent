当前咨询consulation部分比较粗糙，我希望你帮我整体性大改代码，目前控制Agent不选择其他疗法，只选择CBT疗法，需要涉及心理干预的专业知识，即划分CBT大阶段进行对话，各阶段对话贯彻CBT疗法知识。大阶段切换主要靠督导师Supervisor Agent来判断，根据CBT疗法知识满足切换条件可提前切换，否则达到该阶段最大对话轮次也会自动切换至下一阶段。在每个大阶段内，还需要增加代码，通过类似强化学习的机制，初始化一张Agent话题记录表，咨询前的侧写阶段必须给出一个最初的核心对话主题给记录表，这个主题是督导师Agent根据侧写师Agent所有分析报告给出的最核心主题概括，初试分数为5分。在后续咨询师Agent和用户进行咨询对话时，每个QA对话都需要更新这个话题记录表，如果咨询师Agent和用户对话的话题内容贴合最初核心主题，则督导师Agent增加记录表的奖励分数，鼓励咨询师Agent继续保持该话题进行深入沟通；如果是与最初核心主题不相干的主题，则督导师Agent减少记录表的该话题奖励分数，同步开设新对话主题及对话分数（初始化5分），后续对话依次逻辑，按对话分数高的话题控制Agent在每个CBT大阶段和用户的对话内容。整体修改代码尽量少用python的类（class）形式，而是更多用json提供信息进行控制，便于后续代码维护。

1. 遵循CBT分阶段讨论的基本流程，用json提供各阶段知识，知识来自cbt.txt
CBT：
    阶段1: 识别自动思维
    阶段2: 确定思想陷阱
    阶段3: 挑战自动思维
    阶段4: 挑战自动思维
2. 采用“强化学习”的思路的部分，优化奖励惩罚的prompt，调控阶段内话题以及提供完成阶段的量化指标，思路参考enhance.txt
3. 督导师supervisor主要负责控制环节切换和评估咨询师每一轮回答内容的分数

希望你能参考下面的CBT咨询流程，优化代码，具体需要实现两个提升：
    1. 使当前咨询过程可以分阶段（参考Structure文章，建立认知重构疗法4大步；每步中小步可灵活提问；嵌入危险影响因素
    2. 优化督导师Agent执行任务（每轮对话均判断；阶段流转标准由督导师判断，比如大学生是否认同所述事件的思维陷阱，督导师Agent可告诉可引导咨询师Agent），督导技能记忆（每大步结束看一次，看咨询师与大学生对话反思不好且未下降的问卷问题）

待优化：
    1. 我在中间环节已经更新完要素，但无法同步键值对到state，导致尽管已经在上个QA完成这阶段需要满足的要素，但在每个新的QA还是会重置状态，无法进入下一阶段
    2. 当前每个QA过于专业化，AI将每个阶段需要遵循的专业化问题都凝聚在一个QA里面，每个QA都会体现每个阶段所有的专业性内容，尚且无法将专业性内容分散在多个QA中进行人性化的提问
    3. 危险因素先前一直bug，我也没搞清楚它在咨询环节中的定位，目前咨询没加

新待优化：
    1、把危险影响因素加到干预部分
    2、串联测评与干预部分
    3、不同环节的问题稍微更灵活且扣题一些

都解决了！